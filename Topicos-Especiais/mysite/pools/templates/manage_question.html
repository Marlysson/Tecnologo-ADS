{% extends 'base.html' %}

{% block conteudo %}
    
    <div class="row header-question">

        <div class="col-lg-9 
                    col-md-9">

            <h3 class="title-question">
                {{questao.question_text}}

                {% if questao.closed %}
                    <button class="btn btn-danger btn-xs" disabled="disabled">
                        <span class="glyphicon glyphicon-ban-circle"></span>
                        Fechada
                    </button>
                {% else %}
                    <button class="btn btn-success btn-xs" disabled="disabled">
                        <span class="glyphicon glyphicon-ban-circle"></span>
                        Aberta
                    </button>
                {% endif %}

            </h3>
        </div>

        <div class="col-lg-3 
                    col-md-3 options_question">

            <button class="btn btn-default btn-sm toggle_status_question">
                {% if questao.closed %}
                    <strong>Abrir questão</strong>
                {% else %}
                    <strong>Fechar questão</strong>
                {% endif %}
            </button>

            <div class="btn btn-danger btn-sm">
                <strong>Excluir</strong>
            </div>
        </div>
     
    </div>
    

    <form method="post">

        {% csrf_token %}

            <div class="list-group">

                {% for opcao in opcoes %}

                    <li class="list-group-item options-group">

                        <h4 class="option-text">{{opcao.choice_text|capfirst}}</h4>
                        
                        (<strong>{{opcao.votes}} Voto{{opcao.votes|pluralize}}</strong>)

                        <button class="btn btn-primary pull-right btn_remove"
                            id="{{opcao.id}}">
                            <span class="glyphicon glyphicon-remove"></span>
                        </button>

                    </li>

                    {% empty %}
                        Não há opções ainda
                    
                {% endfor %}

                <btn class="btn btn-primary btn-sm btn_add_option">
                    <strong>Criar opção</strong>
                </btn>

            </div>

    </form>


{% endblock %}

{% block scripts %}

    <script type="text/javascript">

        //Tratamento da "exclusão" de uma opção

        btns_exclude = document.querySelectorAll(".btn_remove");

        btns_exclude.forEach(function(element,index){

            element.addEventListener("click",function(event){

                event.preventDefault();

                valor_escolhido = parseInt(this.getAttribute("id"));

                deletar_opcao = confirm("Deseja deletar a opção? ");

                if (deletar_opcao == true){

                    $.ajax({
                        url:"{% url 'remover_opcao' %}",
                        type:"POST",
                        data:{
                            opcao:valor_escolhido,
                            csrfmiddlewaretoken: '{{ csrf_token }}'
                        }

                    }).done(function(data,statusText,request){

                        if (request.status == 200){
                            iziToast.success({
                                timeout:1500,
                                title: 'Removido',
                                message: 'Opção removida com sucesso',
                                position:"topRight"
                            });
                        
                        element.parentNode.remove();

                        }else{

                            iziToast.error({
                                timeout:1000,
                                title: 'Erro',
                                message: 'Ocorreu um erro. Tente novamente.',
                                position:"topRight"
                            });

                        }

                    });
                }
            });

        });

    </script>

    <script type="text/javascript">
        
        //Tratar fechamento da questão

        btn_toggle_status = document.querySelector(".toggle_status_question");

        btn_toggle_status.addEventListener("click",function(event){

            $.ajax({
                url:"{% url 'change_status' %}",
                type:"POST",
                data:{
                    questao:"{{ questao.id }}",
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                }

            }).done(function(data,statusText,request){
                window.location = "{% url 'administrar' questao.id %}";
            });
            
        })

    </script>

{% endblock %}